<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Closing Process - BYUH Accounting</title>
    <style>
        :root {
            --crimson: #ba0c2f;
            --gold: #c69214;
            --light-gold: #fcf2e3;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f4f7f6;
            color: #333;
        }

        h1 { color: var(--crimson); text-align: center; margin-top: 10px; }
        .instruction { text-align: center; font-size: 0.95em; max-width: 800px; margin: 0 auto 20px; }

        /* --- Attempt Tracker (Top) --- */
        #tracker-container {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px dashed var(--gold);
            box-sizing: border-box;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
            text-align: center;
        }

        .history-table th { background: #eee; padding: 8px; border-bottom: 2px solid var(--gold); }
        .history-table td { padding: 6px; border-bottom: 1px solid #ddd; }

        /* --- Main Layout --- */
        .main-layout {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
        }

        /* --- Trial Balance (Left) --- */
        #tb-container {
            flex: 1;
            min-width: 300px;
            background: white;
            border: 2px solid var(--gold);
            border-radius: 8px;
            padding: 15px;
            box-sizing: border-box;
            height: fit-content;
        }

        .tb-table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        .tb-table th { border-bottom: 2px solid var(--crimson); padding: 8px; color: var(--crimson); text-align: left; }
        .tb-table td { padding: 5px 8px; border-bottom: 1px solid #eee; }
        .num { text-align: right; font-family: monospace; }

        /* --- Journal Table (Center) --- */
        #journal-container {
            flex: 2;
            min-width: 350px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            box-sizing: border-box;
        }

        .journal-table { width: 100%; border-collapse: collapse; }
        .journal-table th { background-color: var(--crimson); color: white; padding: 10px; font-size: 0.8em; text-transform: uppercase; }
        .journal-table td { padding: 4px; border: 1px solid #ddd; }

        .acc-select, .dc-select, .amt-input {
            width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9em;
        }

        /* --- Floating Calculator --- */
        #calc-wrapper { flex: 0 0 220px; }
        #calc-container {
            width: 220px;
            background: #333;
            color: white;
            padding: 12px;
            border-radius: 8px;
            position: sticky;
            top: 20px;
            z-index: 100;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        #calc-display {
            width: 100%; background: #222; color: #0f0; text-align: right; padding: 10px; box-sizing: border-box;
            font-family: 'Courier New', monospace; font-size: 1.2em; margin-bottom: 10px; border-radius: 4px; border: 1px solid #444; min-height: 44px;
        }

        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
        .calc-grid button { padding: 12px 0; cursor: pointer; border: none; border-radius: 4px; background: #555; color: white; font-weight: bold; font-size: 1em; }
        .calc-grid button:hover { background: var(--gold); }
        .calc-grid .btn-op { background: var(--gold); }

        /* --- Feedback & Buttons --- */
        .correct { background-color: #e6ffe6 !important; border-color: #4CAF50 !important; }
        .incorrect { background-color: #ffe6e6 !important; border-color: #f44336 !important; }
        
        #submit-btn {
            display: block; width: 100%; max-width: 400px; margin: 25px auto; padding: 15px;
            background-color: var(--gold); color: white; border: none; border-radius: 6px;
            font-size: 1.1em; font-weight: bold; cursor: pointer;
        }

        @media (max-width: 950px) {
            .main-layout { flex-direction: column; }
            #calc-wrapper { width: 100%; flex: none; }
            #calc-container { position: relative; width: 100%; top: 0; margin-bottom: 20px; }
            #tb-container { width: 100%; }
        }

        /* Mobile-friendly: allow journal to scroll horizontally if needed, enlarge tap targets */
        @media (max-width: 600px) {
            #journal-container { overflow-x: auto; }
            .acc-select, .dc-select, .amt-input { font-size: 1rem; padding: 10px; }
            .journal-table th { font-size: 0.85em; }
            #submit-btn { max-width: 100%; }
        }
    </style>
</head>
<body>

    <h1>Closing Entry Challenge</h1>
    <p class="instruction">
        Review the Adjusted Trial Balance. Record the journal entries needed to close all temporary accounts the end of the accounting period. You may close the accounts separately or in groups, by account type.
    </p>

    <div id="tracker-container">
        <table class="history-table">
            <thead>
                <tr>
                    <th>Attempt</th>
                    <th>Revenues Closed</th>
                    <th>Expenses Closed</th>
                    <th>Dividends Closed</th>
                    <th>Score</th>
                </tr>
            </thead>
            <tbody id="history-body">
                <tr><td colspan="5">Identify temporary accounts and record entries below.</td></tr>
            </tbody>
        </table>
    </div>

    <div class="main-layout">
        <div id="tb-container">
            <h3 style="text-align: center; color: var(--crimson); margin: 0 0 10px 0;">Adjusted Trial Balance</h3>
            <table class="tb-table">
                <thead><tr><th>Account</th><th class="num">Debit</th><th class="num">Credit</th></tr></thead>
                <tbody id="tb-body"></tbody>
            </table>
        </div>

        <div id="journal-container">
            <table class="journal-table">
                <thead>
                    <tr><th style="width: 45%;">Account Name</th><th style="width: 15%;">Type</th><th style="width: 40%;">Amount</th></tr>
                </thead>
                <tbody id="journal-body"></tbody>
            </table>
            <button id="submit-btn">Check Journal Entries</button>
        </div>

        <div id="calc-wrapper">
            <div id="calc-container">
                <div id="calc-display">0</div>
                <div class="calc-grid">
                    <button onclick="calcClear()">C</button>
                    <button onclick="calcOp('/')" class="btn-op">÷</button>
                    <button onclick="calcOp('*')" class="btn-op">×</button>
                    <button onclick="calcBackspace()">Del</button>
                    <button onclick="calcNum('7')">7</button><button onclick="calcNum('8')">8</button><button onclick="calcNum('9')">9</button>
                    <button onclick="calcOp('-')" class="btn-op">−</button>
                    <button onclick="calcNum('4')">4</button><button onclick="calcNum('5')">5</button><button onclick="calcNum('6')">6</button>
                    <button onclick="calcOp('+')" class="btn-op">+</button>
                    <button onclick="calcNum('1')">1</button><button onclick="calcNum('2')">2</button><button onclick="calcNum('3')">3</button>
                    <button onclick="calcEq()" style="grid-row: span 2; background: var(--crimson);">=</button>
                    <button onclick="calcNum('0')" style="grid-column: span 2;">0</button><button onclick="calcNum('.')">.</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const accountsList = ["Cash", "Accounts Receivable", "Supplies", "Equipment", "Accumulated Depreciation", "Accounts Payable", "Common Stock", "Retained Earnings", "Dividends", "Service Revenue", "Rent Revenue", "Salaries Expense", "Rent Expense", "Utilities Expense", "Supplies Expense"];
        let tbData = {};
        let attemptCount = 0;
        let isComplete = false;

        function getRandom(min, max) { return Math.round((Math.random() * (max - min) + min) / 100) * 100; }

        function setup() {
            attemptCount = 0;
            isComplete = false;
            document.getElementById('submit-btn').textContent = "Check Journal Entries";
            document.getElementById('submit-btn').style.backgroundColor = "var(--gold)";

            // Ensure revenues > expenses + dividends for every instance
            do {
                tbData = {
                    "Cash": getRandom(7000, 14000),
                    "Equipment": 50000,
                    "Accumulated Depreciation": 10000,
                    "Accounts Payable": getRandom(3000, 6000),
                    "Common Stock": 25000,
                    "Retained Earnings": getRandom(10000, 15000),
                    "Dividends": getRandom(1000, 3000),
                    "Service Revenue": getRandom(45000, 65000),
                    "Rent Revenue": getRandom(2000, 5000),
                    "Salaries Expense": getRandom(14000, 22000),
                    "Rent Expense": getRandom(5000, 8000),
                    "Utilities Expense": getRandom(1000, 2000),
                    "Supplies Expense": getRandom(500, 1500)
                };
                const revTotal = (tbData["Service Revenue"] || 0) + (tbData["Rent Revenue"] || 0);
                const expTotal = (tbData["Salaries Expense"]||0) + (tbData["Rent Expense"]||0) + (tbData["Utilities Expense"]||0) + (tbData["Supplies Expense"]||0);
                const divTotal = tbData["Dividends"]||0;
                if (revTotal > (expTotal + divTotal)) break;
            } while(true);

            renderTB();
            rebuildJournal();
            document.getElementById('history-body').innerHTML = `<tr><td colspan="5">Identify temporary accounts and record entries below.</td></tr>`;
        }

        function renderTB() {
            const body = document.getElementById('tb-body');
            let html = "";
            const order = ["Cash", "Equipment", "Accumulated Depreciation", "Accounts Payable", "Common Stock", "Retained Earnings", "Dividends", "Service Revenue", "Rent Revenue", "Salaries Expense", "Rent Expense", "Utilities Expense", "Supplies Expense"];
            order.forEach(acc => {
                const val = tbData[acc];
                const isDebit = ["Cash", "Equipment", "Dividends", "Salaries Expense", "Rent Expense", "Utilities Expense", "Supplies Expense"].includes(acc);
                html += `<tr><td>${acc}</td><td class="num">${isDebit ? '$'+val.toLocaleString() : ''}</td><td class="num">${!isDebit ? '$'+val.toLocaleString() : ''}</td></tr>`;
            });
            body.innerHTML = html;
        }

        function rebuildJournal() {
            const body = document.getElementById('journal-body');
            body.innerHTML = '';
            let options = accountsList.sort().map(a => `<option value="${a}">${a}</option>`).join('');
            for (let i = 0; i < 15; i++) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><select class="acc-select" id="acc-${i}"><option value="">--Select--</option>${options}</select></td>
                    <td><select class="dc-select" id="dc-${i}"><option value="">--</option><option value="Debit">Debit</option><option value="Credit">Credit</option></select></td>
                    <td><input type="text" class="amt-input" id="amt-${i}" placeholder="0"></td>
                `;
                body.appendChild(tr);
            }
            document.querySelectorAll('.amt-input').forEach(input => {
                input.addEventListener('input', e => {
                    let val = e.target.value.replace(/,/g, '').trim();
                    if (val === "" || val === "-" || val === "." || val === "-.") return;
                    if (!isNaN(val)) {
                        const parts = val.split('.');
                        if (parts.length > 1) {
                            const intPart = parts[0] === "" ? "0" : Number(parts[0]).toLocaleString();
                            e.target.value = intPart + '.' + parts.slice(1).join('');
                        } else {
                            e.target.value = Number(val).toLocaleString();
                        }
                    }
                });
            });
        }

        // --- CALC ---
        let calcVal = "";
        function calcNum(n) { calcVal += n; updateDisp(); }
        function calcOp(op) { if (calcVal.trim() === "") return; calcVal = calcVal.trim() + " " + op + " "; updateDisp(); }
        function calcClear() { calcVal = ""; updateDisp(); }
        function calcBackspace() { if (calcVal.endsWith(" ")) calcVal = calcVal.slice(0, -1); calcVal = calcVal.slice(0, -1); updateDisp(); }

        function updateDisp() {
            const disp = document.getElementById('calc-display');
            if (!calcVal) { disp.innerText = "0"; return; }
            const tokens = calcVal.split(/(\s+)/);
            const out = tokens.map(tok => {
                if (tok.trim() === '') return tok;
                if (/^[+\-*/]$/.test(tok.trim())) return ' ' + tok.trim() + ' ';
                const cleaned = tok.replace(/,/g, '');
                if (!isNaN(cleaned) && cleaned !== "") {
                    if (cleaned.endsWith('.')) {
                        const n = cleaned.slice(0, -1);
                        if (n === "" || isNaN(n)) return cleaned;
                        return Number(n).toLocaleString() + '.';
                    }
                    return Number(cleaned).toLocaleString();
                }
                return tok;
            }).join('');
            disp.innerText = out || "0";
        }

        function calcEq() {
            try {
                if (calcVal.trim() === "") return;
                const expr = calcVal.replace(/×/g, '*').replace(/÷/g, '/');
                if (!/^[0-9+\-*/().\s]+$/.test(expr)) { throw "Bad"; }
                const raw = eval(expr);
                const num = Number(raw);
                if (isNaN(num)) throw "NaN";
                calcVal = num.toString();
                document.getElementById('calc-display').innerText = Number(calcVal).toLocaleString();
            } catch (e) {
                document.getElementById('calc-display').innerText = "Error";
                calcVal = "";
                setTimeout(updateDisp, 800);
            }
        }

        // Keyboard support for calculator when not typing inside inputs/selects
        document.addEventListener('keydown', function(e) {
            const active = document.activeElement;
            const activeTag = active && active.tagName ? active.tagName.toLowerCase() : '';
            const isTyping = (activeTag === 'input' || activeTag === 'textarea' || activeTag === 'select');
            if (isTyping) return;

            if ((e.key >= '0' && e.key <= '9') || e.key === '.' ) { e.preventDefault(); calcNum(e.key); return; }
            if (e.key === '+' || e.key === '-' || e.key === '*' || e.key === '/') { e.preventDefault(); calcOp(e.key); return; }
            if (e.key === 'Enter') { e.preventDefault(); calcEq(); return; }
            if (e.key === 'Backspace' || e.key === 'Delete') { e.preventDefault(); calcBackspace(); return; }
            if (e.key === 'c' || e.key === 'C') { e.preventDefault(); calcClear(); return; }
        });

        // --- GRADING LOGIC ---
        function parseJournalEntries() {
            const rows = [];
            for (let i = 0; i < 15; i++) {
                const aEl = document.getElementById(`acc-${i}`);
                const dEl = document.getElementById(`dc-${i}`);
                const mEl = document.getElementById(`amt-${i}`);
                const acc = aEl ? aEl.value : "";
                const dc = dEl ? dEl.value : "";
                let amt = 0;
                if (mEl && mEl.value) {
                    const cleaned = mEl.value.replace(/,/g, '').trim();
                    if (!isNaN(cleaned) && cleaned !== "") amt = Number(cleaned);
                }
                if (acc) rows.push({acc, dc, amt, accEl: aEl, dcEl: dEl, mEl: mEl, rowIdx: i});
            }

            const perAccount = {};
            let totalDebits = 0, totalCredits = 0;
            rows.forEach(r => {
                if (!perAccount[r.acc]) perAccount[r.acc] = {debits: 0, credits: 0, rows: []};
                if (r.dc === "Debit") {
                    perAccount[r.acc].debits += r.amt;
                    totalDebits += r.amt;
                } else if (r.dc === "Credit") {
                    perAccount[r.acc].credits += r.amt;
                    totalCredits += r.amt;
                }
                perAccount[r.acc].rows.push(r);
            });
            return { rows, perAccount, totalDebits, totalCredits };
        }

        function isClose(a,b, tol=0.5) { return Math.abs(a-b) <= tol; }

        function grade() {
            if (isComplete) { setup(); return; }
            attemptCount++;

            const revAccounts = ["Service Revenue", "Rent Revenue"];
            const expAccounts = ["Salaries Expense", "Rent Expense", "Utilities Expense", "Supplies Expense"];
            const divAccount = "Dividends";

            const revTotal = revAccounts.reduce((s, a) => s + (tbData[a] || 0), 0);
            const expTotal = expAccounts.reduce((s, a) => s + (tbData[a] || 0), 0);
            const divTotal = tbData[divAccount] || 0;

            const parsed = parseJournalEntries();

            // Clear previous classes
            for (let i = 0; i < 15; i++) {
                const aEl = document.getElementById(`acc-${i}`);
                const dEl = document.getElementById(`dc-${i}`);
                const mEl = document.getElementById(`amt-${i}`);
                [aEl, dEl, mEl].forEach(el => { if (el) { el.classList.remove('correct'); el.classList.remove('incorrect'); }});
            }

            // Row correctness map for scoring
            const rowOk = new Map(); // rowIdx -> boolean

            function markRow(r, ok) {
                rowOk.set(r.rowIdx, ok);
                [r.accEl, r.dcEl, r.mEl].forEach(el => {
                    if (!el) return;
                    el.classList.add(ok ? 'correct' : 'incorrect');
                    el.classList.remove(ok ? 'incorrect' : 'correct');
                });
            }

            // PASS 1: Temp accounts must be recorded correctly
            const perAccountCorrect = {};

            function checkTempAccount(acc) {
                const p = parsed.perAccount[acc] || {debits:0, credits:0, rows:[]};
                let ok = false;

                if (revAccounts.includes(acc)) {
                    ok = isClose((p.debits || 0), (tbData[acc] || 0));
                } else if (expAccounts.includes(acc) || acc === divAccount) {
                    ok = isClose((p.credits || 0), (tbData[acc] || 0));
                }
                perAccountCorrect[acc] = ok;

                (p.rows || []).forEach(r => markRow(r, ok));
            }

            revAccounts.forEach(checkTempAccount);
            expAccounts.forEach(checkTempAccount);
            checkTempAccount(divAccount);

            const revAllCorrect = revAccounts.every(a => perAccountCorrect[a] === true);
            const expAllCorrect = expAccounts.every(a => perAccountCorrect[a] === true);
            const divCorrect = (perAccountCorrect[divAccount] === true);

            // Balance check (used for completion, not for row-score partial credit)
            const balanced = isClose(parsed.totalDebits, parsed.totalCredits);

            // PASS 1b: Net retained earnings check (completion gate)
            const expectedRE = revTotal - expTotal - divTotal;   // credit to RE (positive)
            const reP = parsed.perAccount["Retained Earnings"] || {debits:0, credits:0, rows:[]};
            const studentRENet = (reP.credits || 0) - (reP.debits || 0);
            const reNetMatches = isClose(studentRENet, expectedRE);

            // PASS 2: Grade Retained Earnings rows by matching expected contributions
            const contribs = [];
            revAccounts.forEach(a => contribs.push({type: 'rev', val: +(tbData[a]||0), used:false}));
            expAccounts.forEach(a => contribs.push({type: 'exp', val: -(tbData[a]||0), used:false}));
            contribs.push({type: 'div', val: -(tbData[divAccount]||0), used:false});

            const reRows = (reP.rows || []).map(r => ({
                r,
                val: (r.dc === "Credit") ? +r.amt : (r.dc === "Debit" ? -r.amt : 0),
                matched: false
            }));

            function matchExactToAny() {
                for (let i = 0; i < reRows.length; i++) {
                    const rr = reRows[i];
                    if (rr.matched) continue;
                    const idx = contribs.findIndex(c => !c.used && isClose(c.val, rr.val));
                    if (idx >= 0) {
                        rr.matched = true;
                        contribs[idx].used = true;
                        markRow(rr.r, true);
                    }
                }
            }

            function matchByTypeSum(type) {
                const remaining = contribs.filter(c => !c.used && c.type === type);
                if (!remaining.length) return;

                const sum = remaining.reduce((s,c)=> s + c.val, 0);
                for (let i = 0; i < reRows.length; i++) {
                    const rr = reRows[i];
                    if (rr.matched) continue;
                    if (isClose(rr.val, sum)) {
                        rr.matched = true;
                        remaining.forEach(c => c.used = true);
                        markRow(rr.r, true);
                        return;
                    }
                }
            }

            function matchAllRemaining() {
                const remainingAll = contribs.filter(c => !c.used);
                if (!remainingAll.length) return;

                const allSum = remainingAll.reduce((s,c)=> s + c.val, 0);
                for (let i = 0; i < reRows.length; i++) {
                    const rr = reRows[i];
                    if (rr.matched) continue;
                    if (isClose(rr.val, allSum)) {
                        rr.matched = true;
                        remainingAll.forEach(c => c.used = true);
                        markRow(rr.r, true);
                        return;
                    }
                }
            }

            if (reRows.length) {
                matchExactToAny();
                matchByTypeSum('rev');
                matchByTypeSum('exp');
                matchByTypeSum('div');
                matchAllRemaining();

                // Any RE row not matched becomes incorrect (red) so nothing stays white
                reRows.forEach(rr => {
                    if (!rr.matched) markRow(rr.r, false);
                });
            }

            // Any non-temp, non-RE rows that the student filled are incorrect (for row scoring)
            parsed.rows.forEach(r => {
                const isTemp = revAccounts.includes(r.acc) || expAccounts.includes(r.acc) || r.acc === divAccount;
                const isRE = (r.acc === "Retained Earnings");
                if (!isTemp && !isRE) {
                    markRow(r, false);
                }
            });

            // --------- PARTIAL CREDIT SCORE (ROW-BASED) ---------
            // Score = % of filled rows that are correct (green).
            // Blank rows (no account selected) are not counted.
            const gradedRows = parsed.rows.map(r => r.rowIdx);
            let correctCount = 0;
            gradedRows.forEach(idx => { if (rowOk.get(idx) === true) correctCount++; });
            const rowScore = gradedRows.length ? Math.round((correctCount / gradedRows.length) * 100) : 0;

            // Attempt tracker checkmarks still reflect whether each category is fully correct (not partial)
            const revMark = revAllCorrect ? "✅" : "❌";
            const expMark = expAllCorrect ? "✅" : "❌";
            const divMark = divCorrect ? "✅" : "❌";

            const hBody = document.getElementById('history-body');
            if (attemptCount === 1) hBody.innerHTML = "";
            const newRow = document.createElement('tr');
            newRow.innerHTML = `<td>${attemptCount}</td><td>${revMark}</td><td>${expMark}</td><td>${divMark}</td><td>${rowScore}%</td>`;
            hBody.insertAdjacentElement('afterbegin', newRow);

            // Completion: everything correct + balanced + correct RE net + no incorrect filled rows
            const anyIncorrectFilledRow = gradedRows.some(idx => rowOk.get(idx) === false);

            if (!anyIncorrectFilledRow && revAllCorrect && expAllCorrect && divCorrect && balanced && reNetMatches) {
                isComplete = true;
                document.getElementById('submit-btn').textContent = "Excellent! Generate New Assignment";
                document.getElementById('submit-btn').style.backgroundColor = "#2e7d32";
            } else {
                document.getElementById('submit-btn').textContent = "Try Again — Fix Incorrect Entries";
                document.getElementById('submit-btn').style.backgroundColor = "#f57c00";
            }
        }

        document.getElementById('submit-btn').onclick = grade;
        setup();
    </script>
</body>
</html>
